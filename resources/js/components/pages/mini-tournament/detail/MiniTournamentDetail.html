<div class="p-4 max-w-6xl mx-auto">
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
        <!-- Main content -->
        <div class="space-y-6 lg:col-span-2">
            <!-- Tabs -->
            <div class="bg-white rounded-[8px] shadow p-5">
                <div class="flex items-center justify-center space-x-4 flex-wrap">
                    <template v-for="(tab, index) in tabs" :key="tab.name">
                        <button @click="activeTab = tab.name"
                                class="text-sm font-semibold transition-all flex items-center" :class="[
                                    activeTab === tab.name
                                        ? 'bg-red-600 text-white rounded-full px-5 py-2 shadow-sm'
                                        : 'text-gray-700 hover:text-red-600 px-5 py-2'
                                ]">
                            {{ tab.label }}
                        </button>
                        <ChevronRightIcon v-if="index < tabs.length - 1"
                                          class="w-4 h-4 text-gray-500 font-semibold mx-2" />
                    </template>
                </div>
            </div>

            <!-- Tab content -->
            <div class="bg-white rounded-[8px] shadow min-h-[200px] transition-all duration-300"
                 :class="[activeTab === 'chat' ? 'p-0' : 'p-5']">
                <Transition name="fade" mode="out-in">
                    <!-- Tab 1: Chi tiết -->
                    <div v-if="activeTab === 'detail'" key="detail">
                        <!-- Title -->
                        <div class="flex flex-wrap items-center gap-2 mb-4">
                            <h3 class="font-semibold text-gray-900 text-[20px] break-words whitespace-normal min-w-0">
                                {{ mini.name }}
                            </h3>
                            <LockClosedIcon v-if="mini.is_private" class="w-5 h-5" />
                            <LockOpenIcon v-else class="w-5 h-5" />
                        </div>

                        <!-- Time + Location -->
                        <div class="space-y-2 mb-4">
                            <div class="flex items-start gap-2">
                                <CalendarDaysIcon class="w-5 h-5 shrink-0" />
                                <div>
                                    <p class="text-gray-900 font-medium">{{ formatEventDate(mini.starts_at) }}</p>
                                    <p class="text-gray-500 text-sm">{{ mini.duration_minutes }} phút</p>
                                    <a href="#" class="text-blue-600 text-sm font-medium hover:underline">Thêm vào
                                        lịch</a>
                                </div>
                            </div>

                            <div class="flex items-start gap-2">
                                <MapPinIcon class="w-5 h-5 shrink-0" />
                                <div>
                                    <p class="text-gray-900 font-medium">
                                        {{ mini.competition_location?.name }}
                                    </p>
                                    <p class="text-gray-500 text-sm">{{ mini.competition_location?.address }}</p>
                                    <a href="#" class="text-blue-600 text-sm font-medium hover:underline">Hiển thị
                                        trên bản đồ</a>
                                </div>
                            </div>

                            <div class="flex items-center gap-2">
                                <CircleStackIcon class="w-6 h-6" />
                                <span class="text-gray-800">{{ mini.match_type_text }}</span>
                            </div>
                        </div>

                        <!-- Info boxes -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                            <div
                                class="border rounded p-3 flex items-center gap-3 hover:shadow-md transition cursor-pointer">
                                <CircleStackIcon class="w-6 h-6 text-red-600" />
                                <div>
                                    <p class="font-medium text-gray-800">
                                        {{ mini.min_rating != null && mini.max_rating != null
                                        ? `${mini.min_rating} - ${mini.max_rating}`
                                        : 'Không giới hạn'
                                        }}
                                    </p>
                                    <p class="text-sm text-gray-500">Trung bình điểm DUPR</p>
                                </div>
                            </div>

                            <div
                                class="border rounded p-3 flex items-center gap-3 hover:shadow-md transition cursor-pointer">
                                <UserIcon class="w-6 h-6 text-red-600" />
                                <div>
                                    <p class="font-medium text-gray-800">{{ mini.gender_policy_text }}</p>
                                    <p class="text-sm text-gray-500">{{ mini.age_group_text }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-4">
                            <div v-if="!mini.description && !isEditingDescription && isCreator">
                                <a href="javascript:void(0)" @click="setupDescription"
                                   class="text-blue-600 text-sm font-medium hover:underline mt-2 inline-block">Thêm ghi
                                    chú</a>
                            </div>
                            <div v-if="isEditingDescription || mini.description">
                                <label class="block text-gray-800 font-medium mb-2">Thể lệ kèo đấu</label>
                                <textarea rows="4" placeholder="Thêm ghi chú cho kèo đấu" v-model="descriptionModel"
                                          class="w-full rounded border-gray-300 bg-[#EDEEF2] focus:ring-red-500 focus:border-red-500 text-gray-700 text-sm p-3 resize-none"
                                          :class="isCreator ? '' : 'bg-gray-100 cursor-not-allowed'"></textarea>
                                <Transition name="fade">
                                    <button v-if="isDescriptionChanged" @click="saveDescription" :disabled="!isDescriptionChanged"
                                            :class="[
                                            'mt-2 px-4 py-2 font-medium rounded-md transition-colors shadow-md',
                                            isDescriptionChanged
                                              ? 'bg-red-600 text-white hover:bg-red-700'
                                              : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                          ]">
                                        {{ mini.description ? 'Lưu thay đổi' : 'Thêm ghi chú' }}
                                    </button>
                                </Transition>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="flex flex-wrap gap-3" v-if="isCreator">
                            <button @click="publicMiniTournament"
                                    class="flex items-center justify-center gap-2 bg-[#D72D36] hover:bg-white text-white hover:text-[#D72D36] border hover:border-[#D72D36] font-medium px-6 py-2 rounded-md transition">
                                {{ mini?.status == 1 ? 'Công bố kèo đấu' : 'Huỷ công bố' }}
                            </button>

                            <button @click="goToEditPage"
                                    class="flex items-center justify-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-900 font-medium px-4 py-2 rounded-md transition">
                                Chỉnh sửa
                                <PencilIcon class="w-4 h-4" />
                            </button>

                            <button @click="confirmRemoval"
                                    class="flex items-center justify-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-900 font-medium px-4 py-2 rounded-md transition">
                                Hủy bỏ
                                <XCircleIcon class="w-5 h-5" />
                            </button>
                        </div>
                        <template v-else>
                            <div v-if="!currentParticipant">
                                <button class="flex items-center justify-center gap-2 bg-[#D72D36] hover:bg-white text-white hover:text-[#D72D36] border hover:border-[#D72D36] font-medium px-6 py-2 rounded-md transition"
                                    @click="joinerMiniTournament">
                                    Tham gia kèo đấu
                                </button>
                            </div>
                            <div class="flex flex-wrap gap-3" v-else-if="currentParticipant && !isUserConfirmed">
                                <button
                                    class="flex items-center justify-center gap-2 bg-[#D72D36] hover:bg-white text-white hover:text-[#D72D36] border hover:border-[#D72D36] font-medium px-6 py-2 rounded-md transition"
                                    @click="confirmMiniTournament">
                                    Xác nhận lời mời
                                </button>
                                <button @click="confirmDelineMiniParticipant"
                                        class="flex items-center justify-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-900 font-medium px-4 py-2 rounded-md transition">
                                    Từ chối lời mời
                                </button>
                            </div>
                        </template>
                    </div>

                    <!-- Tab 2: Người tham gia -->
                    <div v-else-if="activeTab === 'participants'" key="participants">
                        <div v-if="isCreator" class="flex items-center justify-start border border-[#BBBFCC] rounded px-3 py-2 mb-4">
                            <ArrowTrendingUpIcon class="w-5 h-5 mr-2" />
                            <p class="font-semibold">Quản lý điểm DUPR</p>
                        </div>
                        <div v-if="isCreator" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-4">
                            <div class="flex items-center justify-start border border-[#BBBFCC] rounded px-3 py-2">
                                <CreditCardIcon class="w-5 h-5 mr-2" />
                                <p class="font-semibold">Thanh toán</p>
                            </div>
                            <div
                                class="flex items-center justify-between border border-[#BBBFCC] rounded px-3 py-2">
                                <p class="font-semibold">Duyệt tự động</p>
                                <button @click="toggleAutoApprove"
                                        class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                                        :class="autoApprove ? 'bg-[#D72D36]' : 'bg-gray-300'">
                                        <span
                                            class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                                            :class="autoApprove ? 'translate-x-6' : 'translate-x-1'" />
                                </button>
                            </div>
                        </div>
                        <div class="border border-[#BBBFCC] rounded-lg my-4 p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-[#6B6F80] uppercase text-sm">
                                    NGƯỜI TỔ CHỨC • {{ mini?.staff?.organizer?.length || 0 }}
                                </h4>
                            </div>
                            <div v-if="mini?.staff?.organizer?.length">
                                <div class="grid grid-cols-2 sm:grid-cols-6 lg:grid-cols-6 gap-4">
                                    <UserCard v-for="(item, index) in mini.staff.organizer" :key="index" :id="item.id"
                                              :name="item.user.full_name" :avatar="item.user.avatar_url"
                                              :rating="getUserScore(item.user)" status="approved"  @removeUser="handleRemoveStaff"/>
                                    <UserCard :empty="true" @clickEmpty="openInviteModalDefault" v-if="isCreator" />
                                </div>
                            </div>
                        </div>
                        <div class="border border-[#BBBFCC] rounded-lg my-4 p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-[#6B6F80] uppercase text-sm">
                                    NGƯỜI THAM GIA • {{ mini?.participants?.length || 0 }} / {{
                                        mini.max_players
                                    }}
                                </h4>
                                <span class="text-[#207AD5] text-xs font-semibold cursor-pointer" v-if="isCreator"
                                      @click="openInviteModalWithFriends">Mời bạn bè</span>
                            </div>
                            <div v-if="mini?.participants?.length">
                                <div class="grid grid-cols-2 sm:grid-cols-6 lg:grid-cols-6 gap-4">
                                    <UserCard v-for="(item, index) in mini.participants" :key="index" :id="item.id"
                                              :name="item.user?.full_name" :avatar="item.user?.avatar_url"
                                              :rating="getUserScore(item.user)" @removeUser="handleRemoveUser"
                                              :status="item.is_confirmed == true ? 'approved' : 'pending'" />
                                    <UserCard v-if="mini?.participants?.users?.length < mini.max_players"
                                              :empty="true" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab 3 -->
                    <div v-else-if="activeTab === 'matches'" key="matches">
                        <MiniMatchScheduleTab :isCreator="isCreator" :data="mini" :sportId="mini?.sport?.id"/>
                    </div>

                    <!-- Tab 4 -->
                    <div v-else key="chat" class="flex flex-col h-[70vh]">
                        <ChatFormMiniTournament :miniTournamentId="mini.id" />
                    </div>
                </Transition>
            </div>
        </div>
        <QRcodeModal v-if="showQRCodeModal" :value="miniTournamentLink" @close="showQRCodeModal = false" />

        <!-- Sidebar -->
        <ShareAction :buttons="[
                { label: 'Gửi link', icon: LinkIcon, onClick: copyLink },
                { label: 'Quét mã QR', icon: QrCodeIcon, onClick: showQRCode },
                isCreator ? { label: 'Mời nhóm', icon: UserMultiple, onClick: () => openInviteModalDefault() } : null,
                isCreator ? { label: 'Yêu cầu xác nhận KQ', icon: ClipboardDocumentCheckIcon } : null,
            ].filter(Boolean)" :subtitle="'Hãy chia sẻ thông tin tới bạn bè để cùng tham gia kèo đấu'" />
    </div>

    <!-- Invite Group Modal -->
    <InviteGroup v-model="showInviteModal" :data="inviteGroupData" :clubs="clubs" :active-scope="activeScope"
                 :selected-club="selectedClub" :search-query="searchQuery" :current-radius="currentRadius" :current-club-id="selectedClub" @update:radius="onRadiusChange" @update:searchQuery="onSearchChange"
                 @change-scope="onScopeChange" @change-club="onClubChange" @invite="handleInvite" />
    <DeleteConfirmationModal v-model="showDeleteModal" title="Xác nhận hủy bỏ kèo đấu" message="Thao tác này không thể hoàn tác." confirmButtonText="Xác nhận" @confirm="removeMiniTournament" />
    <DeleteConfirmationModal v-model="showDelineMiniParticipantModal" title="Xác nhận từ chối tham gia kèo đấu" message="Thao tác này không thể hoàn tác." confirmButtonText="Xác nhận" @confirm="declineMiniTournament" />
</div>
